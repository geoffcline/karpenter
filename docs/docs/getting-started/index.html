<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.84.1" /><link rel="alternate" type="application/rss&#43;xml" href="karpenter/docs/getting-started/index.xml">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="/karpenter/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/karpenter/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/karpenter/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/karpenter/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/karpenter/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/karpenter/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/karpenter/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/karpenter/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/karpenter/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/karpenter/favicons/android-192x192.png" sizes="192x192">

<title>Getting Started with Karpenter on AWS | Karpenter</title>
<meta name="description" content="Just-in-time Nodes for Any Kubernetes Cluster"><meta property="og:title" content="Getting Started with Karpenter on AWS" />
<meta property="og:description" content="Just-in-time Nodes for Any Kubernetes Cluster" />
<meta property="og:type" content="website" />
<meta property="og:url" content="karpenter/docs/getting-started/" /><meta property="og:site_name" content="Karpenter" />

<meta itemprop="name" content="Getting Started with Karpenter on AWS">
<meta itemprop="description" content="Just-in-time Nodes for Any Kubernetes Cluster"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Getting Started with Karpenter on AWS"/>
<meta name="twitter:description" content="Just-in-time Nodes for Any Kubernetes Cluster"/>




<link rel="preload" href="/karpenter/scss/main.min.c7864c5e11ce29b0d7fb95d2fbbc92f0cd7d92caacfebfa74a46b09df7d22072.css" as="style">
<link href="/karpenter/scss/main.min.c7864c5e11ce29b0d7fb95d2fbbc92f0cd7d92caacfebfa74a46b09df7d22072.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>





  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="karpenter/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">Karpenter</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="karpenter/docs/getting-started/" ><span class="active">Getting Started Guide</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="karpenter/docs/" ><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/awslabs/karpenter" target="_blank" ><i class='fab fa-github'></i><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




  


<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    
    
    
    
    
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-karpenterdocs-li">
    
      <a href="karpenter/docs/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-karpenterdocs"><span class="">Documentation</span></a>
    
    
      
      <ul class="ul-1">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-karpenterdocsgetting-started-li">
    
      <a href="karpenter/docs/getting-started/" title="Getting Started with Karpenter on AWS" class="align-left pl-0 active td-sidebar-link td-sidebar-link__section" id="m-karpenterdocsgetting-started"><span class="td-sidebar-nav-active-item">Getting Started Guide</span></a>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-karpenterdocsfaqs-li">
    
      <a href="karpenter/docs/faqs/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-karpenterdocsfaqs"><span class="">FAQs</span></a>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-karpenterdocsprovisioner-crd-li">
    
      <a href="karpenter/docs/provisioner-crd/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-karpenterdocsprovisioner-crd"><span class="">Provisioner CRD</span></a>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-karpenterdocsdevelopment-guide-li">
    
      <a href="karpenter/docs/development-guide/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-karpenterdocsdevelopment-guide"><span class="">Development Guide</span></a>
    
    
  </li>

          
        
      </ul>
    
  </li>

    </ul>
  </nav>
</div>




          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
  
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
    
    
      
    
    
    
    
    
    
    

    <a href="https://github.com/awslabs/karpenter/edit/master/website/content/en/docs/getting-started/_index.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
    <a href="https://github.com/awslabs/karpenter/new/master/website/content/en/docs/getting-started/_index.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" target="_blank"><i class="fa fa-edit fa-fw"></i> Create child page</a>
    <a href="https://github.com/awslabs/karpenter/issues/new?title=Getting%20Started%20with%20Karpenter%20on%20AWS" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
    

  
  
  </div>


            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#install">Install</a>
      <ul>
        <li><a href="#required-utilities">Required Utilities</a></li>
        <li><a href="#environment-variables">Environment Variables</a></li>
        <li><a href="#create-a-cluster">Create a Cluster</a></li>
        <li><a href="#setup-authentication-from-kubernetes-to-aws-irsa">Setup Authentication from Kubernetes to AWS (IRSA)</a></li>
        <li><a href="#install-karpenter-helm-chart">Install Karpenter Helm Chart</a></li>
        <li><a href="#provisioner">Provisioner</a></li>
      </ul>
    </li>
    <li><a href="#first-use">First Use</a>
      <ul>
        <li><a href="#create-workload">Create Workload</a></li>
        <li><a href="#automatic-node-provisioning">Automatic Node Provisioning</a></li>
        <li><a href="#automatic-node-deprovisioning-timeout">Automatic Node Deprovisioning (timeout)</a></li>
        <li><a href="#manual-node-deprovisioning">Manual Node Deprovisioning</a></li>
      </ul>
    </li>
    <li><a href="#cleanup">Cleanup</a></li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		







<li class="breadcrumb-item" >
	<a href="karpenter/docs/">Documentation</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="karpenter/docs/getting-started/">Getting Started Guide</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>Getting Started with Karpenter on AWS</h1>
  
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>
	<p>Karpenter automatically provisions new nodes in response to unschedulable
pods. Karpenter does this by observing events within the Kubernetes cluster,
and then sending commands to the underlying cloud provider.</p>
<p>In this example, the cluster is running on Amazon Web Services (AWS) Elastic
Kubernetes Service (EKS). Karpenter is designed to be cloud provider agnostic,
but currently only supports AWS. Contributions are welcomed.</p>
<p>This guide should take less than 1 hour to complete, and cost less than $0.25.
Follow the clean-up instructions to reduce any charges.</p>
<h2 id="install">Install</h2>
<p>Karpenter is installed in clusters with a helm chart.</p>
<p>Karpenter additionally requires IAM Roles for Service Accounts (IRSA). IRSA
permits Karpenter (within the cluster) to make privileged requests to AWS (as
the cloud provider).</p>
<h3 id="required-utilities">Required Utilities</h3>
<p>Install these tools before proceeding:</p>
<ol>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html">AWS CLI</a></li>
<li><code>kubectl</code> - <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">the kubernetes CLI</a></li>
<li><code>eksctl</code> - <a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html">the CLI for AWS EKS</a></li>
</ol>
<p>Login to the AWS CLI with a user that has sufficient privileges to create a
cluster.</p>
<h3 id="environment-variables">Environment Variables</h3>
<p>After setting up the tools, set the following environment variables to store
commonly used values.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#204a87">export</span> <span style="color:#000">CLUSTER_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$USER</span>-karpenter-demo
<span style="color:#204a87">export</span> <span style="color:#000">AWS_DEFAULT_REGION</span><span style="color:#ce5c00;font-weight:bold">=</span>us-west-2
<span style="color:#000">AWS_ACCOUNT_ID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>aws sts get-caller-identity --query Account --output text<span style="color:#204a87;font-weight:bold">)</span>
<span style="color:#000">KARPENTER_VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  https://api.github.com/repos/awslabs/karpenter/releases/latest <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  <span style="color:#000;font-weight:bold">|</span> jq -r <span style="color:#4e9a06">&#39;.tag_name&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</code></pre></div><h3 id="create-a-cluster">Create a Cluster</h3>
<p>Create a cluster with <code>eksctl</code>. The <a href="eks-config.yaml">example configuration</a> file specifies a basic cluster (name, region), and an IAM role for Karpenter to use.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -fsSL  https://raw.githubusercontent.com/awslabs/karpenter/<span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">KARPENTER_VERSION</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>/pkg/cloudprovider/aws/docs/eks-config.yaml <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  <span style="color:#000;font-weight:bold">|</span> envsubst <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  <span style="color:#000;font-weight:bold">|</span> eksctl create cluster -f -
</code></pre></div><p>This guide uses a regular (un-managed) node group to host Karpenter.</p>
<p>Karpenter itself can run anywhere, including on self-managed node groups, <a href="https://docs.aws.amazon.com/eks/latest/userguide/managed-node-groups.html">managed node groups</a>, or <a href="https://aws.amazon.com/fargate/">AWS Fargate</a>.</p>
<p>Karpenter will provision new traditional instances on EC2.</p>
<p>Additionally, the configuration file sets up an <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens">OIDC
provider</a>,
necessary for IRSA (see below). Kubernetes supports OIDC as a standardized way
of communicating with identity providers.</p>
<h3 id="setup-authentication-from-kubernetes-to-aws-irsa">Setup Authentication from Kubernetes to AWS (IRSA)</h3>
<p>IAM Roles for Service Accounts (IRSA) maps Kubernetes resources to roles
(permission sets) on AWS.</p>
<p>First, define a role using the template below. It provides full access to EC2,
and limited access to other services such as EKS and Elastic Container Registry
(ECR).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># Creates IAM resources used by Karpenter</span>
<span style="color:#000">TEMPOUT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>mktemp<span style="color:#204a87;font-weight:bold">)</span>
curl -fsSL https://raw.githubusercontent.com/awslabs/karpenter/<span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">KARPENTER_VERSION</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>/docs/aws/karpenter.cloudformation.yaml &gt; <span style="color:#000">$TEMPOUT</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span><span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> aws cloudformation deploy <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --stack-name Karpenter-<span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --template-file <span style="color:#4e9a06">${</span><span style="color:#000">TEMPOUT</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --capabilities CAPABILITY_NAMED_IAM <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --parameter-overrides <span style="color:#000">ClusterName</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span>
</code></pre></div><p>Second, create the mapping between Kubernetes resources and the new IAM role.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># Add the Karpenter node role to your aws-auth configmap, allowing nodes with this role to connect to the cluster.</span>
eksctl create iamidentitymapping <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --username system:node:<span style="color:#ce5c00;font-weight:bold">{{</span>EC2PrivateDNSName<span style="color:#ce5c00;font-weight:bold">}}</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --cluster  <span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --arn arn:aws:iam::<span style="color:#4e9a06">${</span><span style="color:#000">AWS_ACCOUNT_ID</span><span style="color:#4e9a06">}</span>:role/KarpenterNodeRole-<span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --group system:bootstrappers <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --group system:nodes
</code></pre></div><p>Now, Karpenter can send requests for new EC2 instances to AWS and those instances can connect to your cluster.</p>
<h3 id="install-karpenter-helm-chart">Install Karpenter Helm Chart</h3>
<p>Use helm to deploy Karpenter to the cluster.</p>
<p>We created a Kubernetes service account when we created the cluster using
eksctl. Thus, we don&rsquo;t need the helm chart to do that.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm repo add karpenter https://awslabs.github.io/karpenter/charts
helm repo update
helm upgrade --install karpenter karpenter/karpenter <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>  --namespace karpenter --set serviceAccount.create<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>
</code></pre></div><h3 id="provisioner">Provisioner</h3>
<p>A single Karpenter provisioner is capable of handling many different pod
shapes. In other words, Karpenter eliminates the need to manage many different
node groups. Karpenter makes scheduling and provisioning decisions based on pod
attributes such as labels and affinity.</p>
<p>Create a simple default provisioner using the command below. This provisioner
provides instances with the default certificate bundle, and the control plane
endpoint url.</p>
<p>Importantly, the <code>ttlSecondsAfterEmpty</code> value configures Karpenter to
deprovision empty nodes. This behavior can be disabled by leaving the value
undefined.</p>
<p>Review the <a href="/docs/provisioner-crd">provsioner CRD</a> for more information. For example,
<code>ttlSecondsUntilExpired</code> configures Karpenter to deprovision
nodes when a maximum age is reached.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#4e9a06">&lt;&lt;EOF | kubectl apply -f -
</span><span style="color:#4e9a06">apiVersion: karpenter.sh/v1alpha3
</span><span style="color:#4e9a06">kind: Provisioner
</span><span style="color:#4e9a06">metadata:
</span><span style="color:#4e9a06">  name: default
</span><span style="color:#4e9a06">spec:
</span><span style="color:#4e9a06">  cluster:
</span><span style="color:#4e9a06">    name: ${CLUSTER_NAME}
</span><span style="color:#4e9a06">    endpoint: $(aws eks describe-cluster --name ${CLUSTER_NAME} --query &#34;cluster.endpoint&#34; --output json)
</span><span style="color:#4e9a06">  ttlSecondsAfterEmpty: 30
</span><span style="color:#4e9a06">EOF</span>
kubectl get provisioner default -o yaml
</code></pre></div><h2 id="first-use">First Use</h2>
<p>Karpenter is now active and ready to begin provisioning nodes. Create a
workload (e.g., deployment) to see Karpenter provision some nodes.</p>
<h3 id="create-workload">Create Workload</h3>
<p>This deployment uses the <a href="https://www.ianlewis.org/en/almighty-pause-container">pause image</a> and starts with zero replicas.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#4e9a06">&lt;&lt;EOF | kubectl apply -f -
</span><span style="color:#4e9a06">apiVersion: apps/v1
</span><span style="color:#4e9a06">kind: Deployment
</span><span style="color:#4e9a06">metadata:
</span><span style="color:#4e9a06">  name: inflate
</span><span style="color:#4e9a06">spec:
</span><span style="color:#4e9a06">  replicas: 0
</span><span style="color:#4e9a06">  selector:
</span><span style="color:#4e9a06">    matchLabels:
</span><span style="color:#4e9a06">      app: inflate
</span><span style="color:#4e9a06">  template:
</span><span style="color:#4e9a06">    metadata:
</span><span style="color:#4e9a06">      labels:
</span><span style="color:#4e9a06">        app: inflate
</span><span style="color:#4e9a06">    spec:
</span><span style="color:#4e9a06">      containers:
</span><span style="color:#4e9a06">        - name: inflate
</span><span style="color:#4e9a06">          image: public.ecr.aws/eks-distro/kubernetes/pause:3.2
</span><span style="color:#4e9a06">          resources:
</span><span style="color:#4e9a06">            requests:
</span><span style="color:#4e9a06">              cpu: 1
</span><span style="color:#4e9a06">EOF</span>
</code></pre></div><h3 id="automatic-node-provisioning">Automatic Node Provisioning</h3>
<p>Scale the previous deployment to 5 replicas, and begin watching the Karpenter
pod for log events.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl scale deployment inflate --replicas <span style="color:#0000cf;font-weight:bold">5</span>
kubectl logs -f -n karpenter <span style="color:#204a87;font-weight:bold">$(</span>kubectl get pods -n karpenter -l <span style="color:#000">karpenter</span><span style="color:#ce5c00;font-weight:bold">=</span>controller -o name<span style="color:#204a87;font-weight:bold">)</span>
</code></pre></div><h3 id="automatic-node-deprovisioning-timeout">Automatic Node Deprovisioning (timeout)</h3>
<p>Now, delete the deployment. After 30 seconds (<code>ttlSecondsAfterEmpty</code>),
Karpenter should deprovision the now empty nodes.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete deployment inflate
kubectl logs -f -n karpenter <span style="color:#204a87;font-weight:bold">$(</span>kubectl get pods -n karpenter -l <span style="color:#000">karpenter</span><span style="color:#ce5c00;font-weight:bold">=</span>controller -o name<span style="color:#204a87;font-weight:bold">)</span>
</code></pre></div><h3 id="manual-node-deprovisioning">Manual Node Deprovisioning</h3>
<p>If you delete a node with kubectl, Karpenter terminates the corresponding instance. More specifically, Karpenter adds a node finalizer to properly cordon and drain nodes before they are terminated.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete node <span style="color:#000">$NODE_NAME</span>
</code></pre></div><h2 id="cleanup">Cleanup</h2>
<p>It&rsquo;s important to both delete the cluster instances and the cluster control
plane. AWS charges for both.</p>
<p>Delete cluster workloads and instances:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">helm delete karpenter -n karpenter
aws cloudformation delete-stack --stack-name Karpenter-<span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span>
aws ec2 describe-launch-templates <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    <span style="color:#000;font-weight:bold">|</span> jq -r <span style="color:#4e9a06">&#34;.LaunchTemplates[].LaunchTemplateName&#34;</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    <span style="color:#000;font-weight:bold">|</span> grep -i Karpenter-<span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>    <span style="color:#000;font-weight:bold">|</span> xargs -I<span style="color:#ce5c00;font-weight:bold">{}</span> aws ec2 delete-launch-template --launch-template-name <span style="color:#ce5c00;font-weight:bold">{}</span>
</code></pre></div><p>Delete the control plane:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">eksctl delete cluster --name <span style="color:#4e9a06">${</span><span style="color:#000">CLUSTER_NAME</span><span style="color:#4e9a06">}</span>
</code></pre></div>
        <div class="section-index">
    
    
    
    
    
    
    
</div>

	
	
	<div class="text-muted mt-5 pt-3 border-top">

</div>

</div>

          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/awslabs/karpenter" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://slack.k8s.io/" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 Amazon.com, Inc. or its affiliates. All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 











<script src="/karpenter/js/main.min.00eab555a054c3cf1dc7225432bd5f970d72c0b6b8fce1fb8392ff6392c58d2c.js" integrity="sha256-AOq1VaBUw88dxyJUMr1flw1ywLa4/OH7g5L/Y5LFjSw=" crossorigin="anonymous"></script>




  </body>
</html>